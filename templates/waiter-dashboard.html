<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Waiter Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #ff7b00;
      --secondary: #d86f00;
      --bg-light: #fffaf5;
      --text-dark: #333;
      --card-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg-light: #1e1e1e;
      --text-dark: #ffffff;
      --card-bg: #2a2a2a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navbar */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #ff7b00, #ffae42);
      padding: 15px 40px;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo {
      font-weight: 700;
      font-size: 24px;
      letter-spacing: 1px;
    }

    .logo span {
      color: #fff2e6;
    }

    /* Nav Links */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 30px;
      position: relative;
    }

    .nav-item {
      position: relative;
      cursor: pointer;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      position: relative;
    }

    .nav-links a::after {
      content: "";
      position: absolute;
      width: 0%;
      height: 2px;
      background-color: white;
      left: 0;
      bottom: -4px;
      transition: 0.3s;
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    /* Dropdown menu */
    .dropdown-content {
      display: none;
      position: absolute;
      top: 40px;
      left: 0;
      background-color: var(--card-bg);
      min-width: 180px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      z-index: 999;
    }

    .dropdown-content a {
      color: var(--text-dark);
      padding: 10px 15px;
      display: block;
      text-decoration: none;
      font-weight: 500;
    }

    .dropdown-content a:hover {
      background-color: rgba(255, 123, 0, 0.1);
    }

    .nav-item.open .dropdown-content {
      display: block;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .icon-btn {
      background: white;
      color: var(--secondary);
      border: none;
      padding: 6px 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: 0.3s;
    }

    .icon-btn:hover {
      background: #fff2e6;
    }

    /* Profile Image */
    .profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid white;
      transition: transform 0.2s ease;
    }

    .profile img:hover {
      transform: scale(1.05);
    }

    /* Profile Modal */
    .profile-modal {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background: var(--card-bg);
      color: var(--text-dark);
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      padding: 20px;
      width: 200px;
      z-index: 2000;
    }

    .profile-modal.active {
      display: block;
    }

    .profile-modal h3 {
      margin-bottom: 10px;
      color: var(--primary);
      font-size: 16px;
    }

    .profile-modal p {
      margin: 4px 0;
      font-size: 14px;
    }

    .profile-modal button {
      background: var(--primary);
      border: none;
      color: white;
      padding: 8px 10px;
      border-radius: 6px;
      width: 100%;
      margin-top: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    .profile-modal button:hover {
      background: var(--secondary);
    }

    main {
      flex: 1;
      padding: 40px 60px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 18px;
    }

    header h1 {
      color: var(--secondary);
      font-size: 30px;
    }

    header p {
      color: #555;
      margin-top: 5px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-top: 40px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h3 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    .card p {
      font-size: 22px;
      font-weight: 600;
    }

    .section {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
      transition: 0.3s;
    }

    .section:hover {
      transform: scale(1.01);
    }

    .section h2 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    /* Live table styles */
    .live-table-wrap {
      overflow-x: auto;
      margin-bottom: 16px;
    }

    table.live-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    table.live-table th, table.live-table td {
      padding: 10px 12px;
      border: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }

    table.live-table thead tr {
      background: #fff4e6;
      color: #7a2b00;
    }

    table.live-table tbody tr:hover {
      background: rgba(0,0,0,0.02);
    }

    .filter-buttons {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    .filter-btn.active {
      opacity: 1;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }

    .filter-btn:not(.active) {
      opacity: 0.9;
      box-shadow: none;
      transform: none;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .actions .btn {
      padding: 6px 10px;
      font-size: 13px;
    }

    .btn {
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    .btn.ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(0,0,0,0.06);
    }

    .btn.ghost:hover {
      background: rgba(255, 123, 0, 0.1);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 8px;
      border-radius: 8px;
      background: #fff;
      color: #444;
      border: 1px solid #eee;
      font-weight: 600;
    }

    .small {
      font-size: 12px;
      color: #666;
    }

    .clock-container {
      text-align: right;
    }

    .clock-container .small {
      color: #555;
    }

    #clock {
      font-weight: 700;
      color: var(--primary);
      font-size: 18px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 18px;
      max-width: 520px;
      width: 95%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin: 0 0 8px;
      color: #111;
    }

    .modal pre {
      white-space: pre-wrap;
      background: #faf7f2;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #f2e9dd;
      color: #333;
    }

    .modal .close {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 0;
      background: var(--primary);
      color: white;
      cursor: pointer;
    }

    @media(max-width:768px) {
      nav {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .nav-links {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      
      main {
        padding: 20px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .clock-container {
        text-align: left;
        margin-top: 10px;
      }
      
      .actions {
        flex-direction: column;
      }
      
      th:nth-child(3), td:nth-child(3) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="logo">WAITER <span>DASHBOARD</span></div>

    <div class="nav-links">
      
     
    </div>

    <div class="nav-actions">
      <button class="icon-btn" id="refreshBtn" title="Refresh">ðŸ”„</button>
      <button class="icon-btn" id="themeToggle" title="Toggle Theme">ðŸŒ™</button>
      <div class="profile" id="profileBtn">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Waiter Profile" />
      </div>

      <!-- Profile Modal -->
      <div class="profile-modal" id="profileModal">
        <h3>Profile</h3>
        <p><strong>Name:</strong> {{ session.username if session.username is defined else 'Staff' }}</p>
        <p><strong>Role:</strong> Waiter</p>
        
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Dashboard -->
  <main>
    <header>
      <div>
        <h1>Welcome, {{ session.username if session.username is defined else 'Staff' }}</h1>
        <p>Live orders for serving. Items and quantities only (no prices).</p>
      </div>
      <div class="clock-container">
        <div class="small">Local time</div>
        <div id="clock">--:--:--</div>
      </div>
    </header>

    <!-- Dashboard Cards -->
    <section class="cards">
      <div class="card">
        <h3>Active Orders</h3>
        <p id="activeCount">â€”</p>
      </div>
      <div class="card">
        <h3>Ready to Serve</h3>
        <p id="readyCount">â€”</p>
      </div>
      <div class="card">
        <h3>Pending Delivery</h3>
        <p id="pendingDeliveryCount">â€”</p>
      </div>
      <div class="card">
        <h3>Tables Busy</h3>
        <p id="tablesBusy">â€”</p>
      </div>
    </section>

    <!-- Orders Section -->
    <section class="section">
      <h2>Upcoming Orders</h2>

      <!-- Status filter buttons -->
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="filter-buttons">
          <button class="filter-btn" id="filter-placed" onclick="loadOrders('placed')">Placed</button>
          <button class="filter-btn" id="filter-preparing" onclick="loadOrders('preparing')">Preparing</button>
          <button class="filter-btn" id="filter-ready" onclick="loadOrders('ready')">Ready</button>
          <button class="filter-btn" id="filter-all" onclick="loadOrders('all')">All</button>
        </div>
        <div class="small">Auto-refresh every 6s</div>
      </div>

      <!-- LIVE TABLE: will be populated from /chef/orders -->
      <div class="live-table-wrap" role="region" aria-live="polite">
        <table class="live-table" id="ordersTable">
          <thead>
            <tr>
              <th style="width:80px">Order</th>
              <th>Customer</th>
              <th style="width:160px">Time</th>
              <th>Items (name Ã— qty)</th>
              <th style="width:90px">Table</th>
              <th style="width:120px">Status</th>
              <th style="width:180px">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="7" style="text-align:center;color:#777;padding:18px">Loading ordersâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal (items view) -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Order items</h3>
      <pre id="modalContent">...</pre>
      <button class="close" id="modalClose">Close</button>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const ordersBody = document.getElementById('ordersBody');
    let currentFilter = 'placed';
    let pollInterval = null;

    /* Role provided by server (if not provided, fallback to 'clerk') */
    const USER_ROLE = "{{ user_role if (user_role is defined) else 'clerk' }}";

    /* Clock */
    function updateClock(){ $('#clock').textContent = new Date().toLocaleString(); }
    setInterval(updateClock,1000); updateClock();

    /* Theme toggle */
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener("click", () => {
      const currentTheme = document.body.getAttribute("data-theme");
      if (currentTheme === "dark") {
        document.body.removeAttribute("data-theme");
        themeToggle.textContent = "ðŸŒ™";
      } else {
        document.body.setAttribute("data-theme", "dark");
        themeToggle.textContent = "â˜€ï¸";
      }
    });

    /* Profile modal toggle */
    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    profileBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      profileModal.classList.toggle("active");
    });
    document.addEventListener("click", (e) => {
      if (!profileModal.contains(e.target) && !profileBtn.contains(e.target)) {
        profileModal.classList.remove("active");
      }
    });

    /* Refresh button */
    document.getElementById("refreshBtn").addEventListener("click", () => {
      loadOrders(currentFilter);
    });

    /* Modal helpers */
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    
    function openModal(title, text){
      modalTitle.textContent = title;
      modalContent.textContent = text;
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
    }
    
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
    }
    
    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });

    /* Filter buttons (to show active state and remember current filter) */
    const filterButtons = {
      placed: document.getElementById('filter-placed'),
      preparing: document.getElementById('filter-preparing'),
      ready: document.getElementById('filter-ready'),
      all: document.getElementById('filter-all')
    };

    // helper: mark active filter button
    function setActiveFilter(name) {
      currentFilter = name || 'placed';
      for (const k in filterButtons) {
        const btn = filterButtons[k];
        if (!btn) continue;
        if (k === currentFilter) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      }
    }

    /* Render items as lines */
    function renderItemsList(items){
      if (!items || !items.length) return 'No items';
      return items.map(it => {
        const name = it.item_name || it.name || 'Item';
        const qty = (it.qty !== undefined) ? it.qty : (it.quantity || 1);
        return `${name} Ã—${qty}`;
      }).join('\n');
    }

    /* Adaptive action buttons based on role and status */
    function createActionButtons(order){
      const wrapper = document.createElement('div');
      wrapper.className = 'actions';

      // View details -> modal
      const btnView = document.createElement('button');
      btnView.className = 'btn ghost';
      btnView.textContent = 'View';
      btnView.onclick = () => {
        const title = `Order #${order.id}`;
        const lines = [];
        lines.push(`Customer: ${order.customer_name || 'Guest'}`);
        lines.push(`Table: ${order.table_no || 'â€”'}`);
        lines.push('');
        lines.push('Items:');
        lines.push(renderItemsList(order.items));
        openModal(title, lines.join('\n'));
      };
      wrapper.appendChild(btnView);

      const status = (order.current_status || order.order_status || '').toLowerCase();

      async function postChefStatus(newStatus){
        try {
          const resp = await fetch('/chef/update_order_status', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ order_id: order.id, new_status: newStatus })
          });
          const data = await resp.json().catch(()=>null);
          if (!resp.ok) return alert('Failed: ' + (data && data.message ? data.message : resp.statusText));
          await loadOrders(currentFilter);
        } catch (err) { console.error(err); alert('Server error'); }
      }

      async function postDeliver(){
        try {
          const resp = await fetch('/clerk/complete_order', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ order_id: order.id, payment_status: 'paid' })
          });
          const data = await resp.json().catch(()=>null);
          if (!resp.ok) return alert('Failed: ' + (data && data.message ? data.message : resp.statusText));
          await loadOrders(currentFilter);
        } catch (err) { console.error(err); alert('Server error'); }
      }

      // Role-based controls:
      // - CHEF: can Start Preparing and Mark Ready
      // - CLERK/WAITER: can Mark Delivered only (but can View)
      if (USER_ROLE === 'chef'){
        if (status === 'placed' || status === 'pending') {
          const b = document.createElement('button'); b.className='btn'; b.textContent='Start Preparing';
          b.onclick = ()=> { if (confirm('Start preparing order #' + order.id + '?')) postChefStatus('preparing'); };
          wrapper.appendChild(b);
        } else if (status === 'preparing' || status === 'cooking') {
          const b = document.createElement('button'); b.className='btn'; b.textContent='Mark Ready';
          b.onclick = ()=> { if (confirm('Mark order #' + order.id + ' Ready?')) postChefStatus('ready'); };
          wrapper.appendChild(b);
        } else if (status === 'ready') {
          const b = document.createElement('button'); b.className='btn'; b.textContent='Mark Delivered';
          b.onclick = ()=> { if (confirm('Mark order #' + order.id + ' delivered?')) postDeliver(); };
          wrapper.appendChild(b);
        }
      } else { // waiter/clerk
        if (status === 'ready') {
          const b = document.createElement('button'); b.className='btn'; b.textContent='Mark Delivered';
          b.onclick = ()=> { if (confirm('Mark order #' + order.id + ' delivered?')) postDeliver(); };
          wrapper.appendChild(b);
        }
        // optionally waiters could request "Start Preparing" if you prefer; currently only chefs start preparing
      }

      return wrapper;
    }

    /* Load orders and populate table */
    async function loadOrders(status='placed'){
      setActiveFilter(status);
      ordersBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#777;padding:16px">Loadingâ€¦</td></tr>';
      try {
        const res = await fetch('/chef/orders?status=' + encodeURIComponent(status), {cache:'no-store'});
        if (!res.ok) {
          ordersBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#b91c1c">Server error ${res.status}</td></tr>`;
          setSummaryCounts([], true); return;
        }
        const payload = await res.json().catch(()=>null);
        if (!payload || !payload.success) {
          ordersBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#b91c1c">Invalid response</td></tr>`;
          setSummaryCounts([], true); return;
        }

        const orders = payload.orders || [];
        setSummaryCounts(orders);
        if (!orders.length) {
          ordersBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;padding:16px">No orders found.</td></tr>';
          return;
        }

        ordersBody.innerHTML = '';
        for (const o of orders){
          const tr = document.createElement('tr');
          const tdOrder = document.createElement('td'); tdOrder.textContent = '#' + o.id; tr.appendChild(tdOrder);
          const tdCustomer = document.createElement('td'); tdCustomer.innerHTML = `<strong>${o.customer_name || 'Guest'}</strong><div class="small">${o.customer_email || ''}</div>`; tr.appendChild(tdCustomer);
          const tdTime = document.createElement('td'); tdTime.textContent = o.created_at ? new Date(o.created_at).toLocaleString() : ''; tr.appendChild(tdTime);
          const tdItems = document.createElement('td'); tdItems.style.whiteSpace = 'pre-line'; tdItems.style.fontSize = '13px'; tdItems.style.color = '#333'; tdItems.textContent = renderItemsList(o.items); tr.appendChild(tdItems);
          const tdTable = document.createElement('td'); tdTable.textContent = o.table_no || 'â€”'; tr.appendChild(tdTable);
          const tdStatus = document.createElement('td'); tdStatus.innerHTML = `<span class="status-badge">${o.current_status || o.order_status || 'placed'}</span>`; tr.appendChild(tdStatus);
          const tdActions = document.createElement('td'); tdActions.appendChild(createActionButtons(o)); tr.appendChild(tdActions);
          ordersBody.appendChild(tr);
        }
      } catch (err) {
        console.error('loadOrders err', err);
        ordersBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#b91c1c">Error loading orders (see console)</td></tr>';
        setSummaryCounts([], true);
      }
    }

    function setSummaryCounts(orders, error=false){
      if (error){
        $('#activeCount').textContent = 'â€”'; $('#readyCount').textContent = 'â€”'; $('#pendingDeliveryCount').textContent = 'â€”'; $('#tablesBusy').textContent = 'â€”';
        return;
      }
      let active=0, ready=0, pendingDelivery=0;
      const tables = new Set();
      for (const o of orders){
        const s = (o.current_status || o.order_status || '').toLowerCase();
        if (s === 'ready') ready++;
        if (s === 'placed' || s === 'preparing' || s === 'cooking') active++;
        if (s === 'placed' || s === 'ready') pendingDelivery++;
        if (o.table_no) tables.add(o.table_no);
      }
      $('#activeCount').textContent = active;
      $('#readyCount').textContent = ready;
      $('#pendingDeliveryCount').textContent = pendingDelivery;
      $('#tablesBusy').textContent = tables.size || 'â€”';
    }

    /* Logout & profile navigation */
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) logoutBtn.addEventListener("click", () => { window.location.href = "{{ logout_url if (logout_url is defined) else url_for('home') }}"; });

    const viewProfileBtn = document.getElementById("viewProfileBtn");
    if (viewProfileBtn) viewProfileBtn.addEventListener("click", () => { 
      // Add view profile functionality here
      alert("View Profile functionality would go here");
    });

    /* Start polling */
    loadOrders(currentFilter);
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(()=> loadOrders(currentFilter), 6000);
  </script>
</body>
</html>